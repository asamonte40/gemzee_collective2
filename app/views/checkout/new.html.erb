<h1>Checkout</h1>

<div class="checkout-container">
  <div class="checkout-form">
    <h2>Shipping Information</h2>

    <% if @user.province.blank? || params[:edit_address] == 'true' %>
    <%= form_with url: checkout_path, method: :post, local: true do |f| %>
      <%= fields_for :user, @user do |uf| %>
        <div class="form-group">
          <%= uf.label :address %>
          <%= uf.text_field :address, required: true %>
        </div>
        <div class="form-group">
          <%= uf.label :city %>
          <%= uf.text_field :city, required: true %>
        </div>
        <div class="form-group">
          <%= uf.label :postal_code %>
          <%= uf.text_field :postal_code, required: true %>
        </div>
        <div class="form-group">
          <%= uf.label :province_id, "Province" %>
          <%= uf.collection_select :province_id, @provinces, :id, :name, { prompt: 'Select Province' }, { required: true } %>
        </div>
      <% end %>
      <%= f.submit 'Continue to Payment', class: 'btn btn-primary' %>
    <% end %>
  <% else %>

    <!-- Order Summary -->
    <div class="address-display">
      <p><strong><%= @user.name %></strong></p>
      <p><%= @user.address %></p>
      <p><%= @user.city %>, <%= @user.province.code %> <%= @user.postal_code %></p>
      <p><%= link_to 'Change address', checkout_path(edit_address: true) %></p>
    </div>

    <h2>Order Summary</h2>
    <% @cart_items.each do |item| %>
      <div class="summary-item">
        <span><%= item[:product].name %> Ã— <%= item[:quantity] %></span>
        <span><%= number_to_currency(item[:product].price * item[:quantity]) %></span>
      </div>
    <% end %>
    <h3>Total: <%= number_to_currency(@total) %></h3>

    <!-- Stripe Payment Form -->
    <h2>Pay with Card (Test Mode)</h2>
    <form id="payment-form" data-publishable-key="<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>"
          data-order-id="<%= @order.id %>"
          data-user-name="<%= @user.name %>"
          data-user-email="<%= current_user.email %>">
      <div id="card-element" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
      <button id="submit-button" type="submit" class="btn btn-success">
        Pay <%= number_to_currency(@total) %>
      </button>
      <div id="payment-message" style="color: red; margin-top: 10px;"></div>
    </form>

    <%= javascript_include_tag "https://js.stripe.com/v3/" %>
    <script type="module" src="<%= 'checkout.js' %>"></script>

  <% end %>
</div>
</div>